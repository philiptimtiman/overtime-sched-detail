<!DOCTYPE html>
<html>
<head>
  <title>Overtime Dashboard (Live)</title>
  <meta charset="utf-8" />
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 20px;
      background: #f4f6f9;
      color: #333;
    }

    h1 {
      text-align: center;
      color: #007BFF;
      margin-bottom: 12px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 14px;
    }

    #search {
      padding: 10px;
      width: 320px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    #authBtn {
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      background: #007BFF;
      color: #fff;
      cursor: pointer;
    }

    #authBtn:hover { background: #0056b3; }

    form {
      margin-bottom: 18px;
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    input, button {
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      background: #007BFF;
      color: white;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    button:hover { background: #0056b3; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    th, td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      text-align: center;
    }

    th {
      background: #007BFF;
      color: white;
      font-weight: 600;
      cursor: pointer;
    }

    tr:hover { background: #f1f9ff; }

    .delete-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 6px 10px;
      cursor: pointer;
      border-radius: 4px;
    }

    .delete-btn:hover { background: #c82333; }

    /* Simple modal for login/signup */
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.4);
      z-index: 1000;
    }

    .modal.open { display: flex; }

    .modal-card {
      background: #fff;
      padding: 18px;
      border-radius: 8px;
      width: 360px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.2);
    }

    .modal-card h3 { margin-top: 0; }

    .modal-card input { width: 100%; margin-bottom: 8px; }

    .small {
      font-size: 13px;
      color: #666;
      text-align: center;
      margin-top: 8px;
    }

    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>Overtime Dashboard (Live)</h1>

  <div class="top-bar">
    <input type="text" id="search" placeholder="Search by name, date, or notes..." autocomplete="off">
    <div>
      <button id="authBtn">Login / Signup</button>
    </div>
  </div>

  <form id="entryForm">
    <input type="number" id="id" placeholder="ID" required autocomplete="off">
    <input type="text" id="name" placeholder="Name" required autocomplete="name">
    <input type="date" id="date" required autocomplete="off">
    <input type="text" id="notes" placeholder="Notes" autocomplete="off">
    <button type="submit">Add Entry</button>
  </form>

  <table id="entriesTable">
    <thead>
      <tr>
        <th>ID</th>
        <th id="sortName">Name ▲▼</th>
        <th id="sortDate">Date ▲▼</th>
        <th>Notes</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="entries"></tbody>
  </table>

  <!-- Login / Signup Modal -->
  <div id="authModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <h3 id="modalTitle">Login</h3>

      <div id="loginForm">
        <input id="authEmail" type="email" placeholder="Email" autocomplete="email" required>
        <input id="authPassword" type="password" placeholder="Password" autocomplete="current-password" required>
        <div style="display:flex; gap:8px;">
          <button id="loginSubmit">Login</button>
          <button id="signupSubmit" type="button">Signup</button>
        </div>
        <div class="small">Or request a magic link via email in Supabase Auth settings</div>
      </div>

      <div style="text-align:right; margin-top:8px;">
        <button id="closeModal" style="background:#ccc; color:#000;">Close</button>
      </div>
    </div>
  </div>

  <script type="module" src="app.js"></script>
</body>
</html>




import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

// --- Replace with your Supabase project values ---
const SUPABASE_URL = "https://your-project.supabase.co";
const SUPABASE_ANON_KEY = "your-anon-public-key";
// -------------------------------------------------------

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let allEntries = [];
let currentUser = null;
let sortDirection = { name: "asc", date: "asc" };

// ---------- Auth UI helpers ----------
const authBtn = document.getElementById("authBtn");
const authModal = document.getElementById("authModal");
const closeModal = document.getElementById("closeModal");
const loginSubmit = document.getElementById("loginSubmit");
const signupSubmit = document.getElementById("signupSubmit");
const authEmail = document.getElementById("authEmail");
const authPassword = document.getElementById("authPassword");
const modalTitle = document.getElementById("modalTitle");

function openAuthModal() {
  authModal.classList.add("open");
  modalTitle.textContent = "Login or Signup";
  authEmail.value = "";
  authPassword.value = "";
}

function closeAuthModal() {
  authModal.classList.remove("open");
}

authBtn.addEventListener("click", () => {
  if (!currentUser) openAuthModal();
  else logoutFlow();
});

closeModal.addEventListener("click", closeAuthModal);
authModal.addEventListener("click", (e) => { if (e.target === authModal) closeAuthModal(); });

// ---------- Auth flows ----------
async function refreshAuthState() {
  const { data } = await supabase.auth.getUser();
  currentUser = data?.user ?? null;
  updateUiForAuth();
}

function updateUiForAuth() {
  const form = document.getElementById("entryForm");
  if (!currentUser) {
    form.style.display = "none";
    authBtn.textContent = "Login / Signup";
  } else {
    form.style.display = "flex";
    authBtn.textContent = "Logout";
  }
  renderEntries(allEntries);
}

async function loginFlow() {
  const email = authEmail.value?.trim();
  const password = authPassword.value;

  if (!email || !password) {
    alert("Please enter both email and password.");
    return;
  }

  const { data, error } = await supabase.auth.signInWithPassword({ email, password });

  if (error) {
    console.error("Login error:", error);
    alert("Login failed: " + (error.message || error));
    return;
  }

  currentUser = data.user ?? null;
  updateUiForAuth();
  closeAuthModal();
  await loadEntries();
}

async function signupFlow() {
  const email = authEmail.value?.trim();
  const password = authPassword.value;

  if (!email || !password) {
    alert("Please enter both email and password to sign up.");
    return;
  }

  const { data, error } = await supabase.auth.signUp({ email, password });

  if (error) {
    console.error("Signup error:", error);
    alert("Signup failed: " + (error.message || error));
    return;
  }

  // If email confirmations are enabled, user may need to confirm via email
  alert("Signup successful. Check your email to confirm if required by your Supabase settings.");
  currentUser = data.user ?? null;
  updateUiForAuth();
  closeAuthModal();
  await loadEntries();
}

async function logoutFlow() {
  const { error } = await supabase.auth.signOut();
  if (error) {
    console.error("Logout error:", error);
    alert("Logout failed: " + (error.message || error));
    return;
  }
  currentUser = null;
  updateUiForAuth();
  await loadEntries();
}

loginSubmit.addEventListener("click", async (e) => { e.preventDefault(); await loginFlow(); });
signupSubmit.addEventListener("click", async (e) => { e.preventDefault(); await signupFlow(); });

// Keep UI in sync across tabs
supabase.auth.onAuthStateChange((_event, session) => {
  currentUser = session?.user ?? null;
  updateUiForAuth();
});

// ---------- Data loading ----------
async function loadEntries() {
  const { data, error } = await supabase.from("overtime_entries").select("*");
  if (error) {
    console.error("Error loading entries:", error);
    allEntries = [];
    renderEntries(allEntries);
    return;
  }
  allEntries = data || [];
  renderEntries(allEntries);
}

// ---------- Rendering ----------
function renderEntries(entries) {
  const tbody = document.getElementById("entries");
  tbody.innerHTML = "";

  if (!entries || entries.length === 0) {
    const row = document.createElement("tr");
    const cell = document.createElement("td");
    cell.colSpan = 5;
    cell.textContent = "No entries found.";
    row.appendChild(cell);
    tbody.appendChild(row);
    return;
  }

  entries.forEach(entry => {
    const row = document.createElement("tr");

    const idCell = document.createElement("td");
    idCell.textContent = entry.id ?? "(no id)";

    const nameCell = document.createElement("td");
    nameCell.textContent = entry.name ?? "(no name)";

    const dateCell = document.createElement("td");
    dateCell.textContent = entry.date ?? "(no date)";

    const notesCell = document.createElement("td");
    notesCell.textContent = entry.notes ?? "";

    const actionCell = document.createElement("td");

    if (currentUser) {
      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Delete";
      deleteBtn.className = "delete-btn";
      deleteBtn.addEventListener("click", async () => {
        if (!confirm(`Delete entry ID ${entry.id}?`)) return;
        const { error } = await supabase.from("overtime_entries").delete().eq("id", entry.id);
        if (error) {
          console.error("Delete error:", error);
          alert("Failed to delete entry: " + (error.message || error));
        } else {
          await loadEntries();
        }
      });
      actionCell.appendChild(deleteBtn);

      const editBtn = document.createElement("button");
      editBtn.textContent = "Edit";
      editBtn.style.marginLeft = "8px";
      editBtn.addEventListener("click", () => openEditDialog(entry));
      actionCell.appendChild(editBtn);
    } else {
      actionCell.textContent = "-";
    }

    row.appendChild(idCell);
    row.appendChild(nameCell);
    row.appendChild(dateCell);
    row.appendChild(notesCell);
    row.appendChild(actionCell);

    tbody.appendChild(row);
  });
}

// ---------- Inline edit ----------
async function openEditDialog(entry) {
  const newName = window.prompt("Edit name:", entry.name ?? "");
  if (newName === null) return;
  const newDate = window.prompt("Edit date (YYYY-MM-DD):", entry.date ?? "");
  if (newDate === null) return;
  const newNotes = window.prompt("Edit notes:", entry.notes ?? "");
  if (newNotes === null) return;

  const { error } = await supabase.from("overtime_entries").update({ name: newName, date: newDate, notes: newNotes }).eq("id", entry.id);
  if (error) {
    console.error("Update error:", error);
    alert("Failed to update entry: " + (error.message || error));
  } else {
    await loadEntries();
  }
}

// ---------- Form submission ----------
function setupForm() {
  const form = document.getElementById("entryForm");
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    if (!currentUser) {
      alert("You must be logged in to add entries.");
      return;
    }

    const id = document.getElementById("id").value;
    const name = document.getElementById("name").value;
    const date = document.getElementById("date").value;
    const notes = document.getElementById("notes").value;

    if (!id || !name || !date) {
      alert("Please fill ID, Name, and Date.");
      return;
    }

    const { error } = await supabase.from("overtime_entries").insert([{ id: parseInt(id, 10), name, date, notes }]);
    if (error) {
      console.error("Insert error:", error);
      alert("Failed to add entry: " + (error.message || error));
    } else {
      form.reset();
      await loadEntries();
    }
  });
}

// ---------- Search ----------
function setupSearch() {
  const searchInput = document.getElementById("search");
  searchInput.addEventListener("input", () => {
    const q = searchInput.value.toLowerCase();
    const filtered = allEntries.filter(entry =>
      (entry.name?.toLowerCase().includes(q)) ||
      (entry.date?.toLowerCase().includes(q)) ||
      (entry.notes?.toLowerCase().includes(q))
    );
    renderEntries(filtered);
  });
}

// ---------- Sorting ----------
function setupSorting() {
  const nameHeader = document.getElementById("sortName");
  const dateHeader = document.getElementById("sortDate");

  nameHeader.addEventListener("click", () => {
    sortDirection.name = sortDirection.name === "asc" ? "desc" : "asc";
    const sorted = [...allEntries].sort((a, b) => {
      const aName = (a.name ?? "").toString();
      const bName = (b.name ?? "").toString();
      return sortDirection.name === "asc"
        ? aName.localeCompare(bName, undefined, { sensitivity: "base" })
        : bName.localeCompare(aName, undefined, { sensitivity: "base" });
    });
    updateSortIndicators();
    renderEntries(sorted);
  });

  dateHeader.addEventListener("click", () => {
    sortDirection.date = sortDirection.date === "asc" ? "desc" : "asc";
    const sorted = [...allEntries].sort((a, b) => {
      const aDate = a.date ? new Date(a.date) : new Date(0);
      const bDate = b.date ? new Date(b.date) : new Date(0);
      return sortDirection.date === "asc" ? aDate - bDate : bDate - aDate;
    });
    updateSortIndicators();
    renderEntries(sorted);
  });
}

function updateSortIndicators() {
  const nameHeader = document.getElementById("sortName");
  const dateHeader = document.getElementById("sortDate");
  nameHeader.textContent = `Name ${sortDirection.name === "asc" ? "▲" : "▼"}`;
  dateHeader.textContent = `Date ${sortDirection.date === "asc" ? "▲" : "▼"}`;
}

// ---------- Realtime ----------
function setupRealtime() {
  supabase
    .channel("overtime")
    .on("postgres_changes", { event: "*", schema: "public", table: "overtime_entries" }, (payload) => {
      console.log("Realtime change:", payload);
      loadEntries();
    })
    .subscribe();
}

// ---------- Init ----------
async function init() {
  setupForm();
  setupSearch();
  setupSorting();
  updateSortIndicators();
  await refreshAuthState();
  setupRealtime();
  await loadEntries();
}

init();
